# Set window title
function set_window_title() {
    echo -ne "\033]0; $(basename "$PWD") \007"
}
precmd_functions+=(set_window_title)

# Locales (needed for mosh)
export LANG=en_US.UTF-8
export LC_CTYPE=en_US.UTF-8

# Default to emacs keymap
bindkey -e

if [ `uname` = "Darwin" ]; then
    # MacOS specific stuff
    fzf_bin_dir=/usr/local/opt/fzf/bin
    fzf_shell_dir=/usr/local/opt/fzf/shell
    zsh_plugin_dir=/usr/local/share

    # Add Homebrew sbin to path
    [[ ! "$PATH" == */usr/local/sbin* ]] && export PATH="/usr/local/sbin:$PATH"

    alias ls='ls -G'

elif [ `uname` = "Linux" ]; then
    # Linux specific stuff
    fzf_bin_dir=/usr/bin
    fzf_shell_dir=/usr/share/fzf
    [ ! -d $fzf_shell_dir ] && fzf_shell_dir=/usr/share/doc/fzf/examples
    zsh_plugin_dir=/usr/share/zsh/plugins
    [ ! -d $zsh_plugin_dir ] && zsh_plugin_dir=/usr/share

    alias ls='ls --color=auto'

fi

# Load NVM
# Note: still need to call `nvm init` before using Node
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh" --no-use

# Load Rust
[[ ! "$PATH" == *cargo/bin* && -d $HOME/.cargo/bin ]] && export PATH="$HOME/.cargo/bin:$PATH"

# Load Ruby
rbenv() {
    echo "Ruby env not loaded! Loading now..."
    unset -f rbenv
    which rbenv > /dev/null && eval "$(rbenv init -)"
    # Use Homebrew's (updated) OpenSSL with Ruby
    export RUBY_CONFIGURE_OPTS="--with-openssl-dir=$(brew --prefix openssl@1.1)"

    rbenv "$@"
}

# Setup starship prompt
eval "$(starship init zsh)"

# LS_COLORS (from `vivid generate snazzy`)
export LS_COLORS='mi=0;38;2;0;0;0;48;2;255;92;87:pi=0;38;2;0;0;0;48;2;87;199;255:cd=0;38;2;255;106;193;48;2;51;51;51:ex=1;38;2;255;92;87:no=0:bd=0;38;2;154;237;254;48;2;51;51;51:mh=0:rs=0:so=0;38;2;0;0;0;48;2;255;106;193:sg=0:fi=0:do=0;38;2;0;0;0;48;2;255;106;193:tw=0:ln=0;38;2;255;106;193:di=0;38;2;87;199;255:st=0:or=0;38;2;0;0;0;48;2;255;92;87:ca=0:su=0:ow=0:*~=0;38;2;102;102;102:*.d=0;38;2;90;247;142:*.a=1;38;2;255;92;87:*.c=0;38;2;90;247;142:*.p=0;38;2;90;247;142:*.t=0;38;2;90;247;142:*.z=4;38;2;154;237;254:*.h=0;38;2;90;247;142:*.m=0;38;2;90;247;142:*.o=0;38;2;102;102;102:*.r=0;38;2;90;247;142:*.ps=0;38;2;255;92;87:*.fs=0;38;2;90;247;142:*.hs=0;38;2;90;247;142:*.pp=0;38;2;90;247;142:*.7z=4;38;2;154;237;254:*.lo=0;38;2;102;102;102:*.la=0;38;2;102;102;102:*.jl=0;38;2;90;247;142:*.go=0;38;2;90;247;142:*.nb=0;38;2;90;247;142:*.rs=0;38;2;90;247;142:*.rm=0;38;2;255;180;223:*.td=0;38;2;90;247;142:*.sh=0;38;2;90;247;142:*.di=0;38;2;90;247;142:*.pm=0;38;2;90;247;142:*.as=0;38;2;90;247;142:*.ex=0;38;2;90;247;142:*.cr=0;38;2;90;247;142:*.ml=0;38;2;90;247;142:*.hh=0;38;2;90;247;142:*.cc=0;38;2;90;247;142:*.bc=0;38;2;102;102;102:*.js=0;38;2;90;247;142:*.ko=1;38;2;255;92;87:*.ts=0;38;2;90;247;142:*.so=1;38;2;255;92;87:*.gv=0;38;2;90;247;142:*.py=0;38;2;90;247;142:*css=0;38;2;90;247;142:*.xz=4;38;2;154;237;254:*.ui=0;38;2;243;249;157:*.wv=0;38;2;255;180;223:*.el=0;38;2;90;247;142:*.md=0;38;2;243;249;157:*.rb=0;38;2;90;247;142:*.cs=0;38;2;90;247;142:*.ll=0;38;2;90;247;142:*.hi=0;38;2;102;102;102:*.pl=0;38;2;90;247;142:*.kt=0;38;2;90;247;142:*.vb=0;38;2;90;247;142:*.bz=4;38;2;154;237;254:*.gz=4;38;2;154;237;254:*.mn=0;38;2;90;247;142:*.cp=0;38;2;90;247;142:*.tbz=4;38;2;154;237;254:*.php=0;38;2;90;247;142:*.epp=0;38;2;90;247;142:*.exs=0;38;2;90;247;142:*.bsh=0;38;2;90;247;142:*.mp4=0;38;2;255;180;223:*.rpm=4;38;2;154;237;254:*.dll=1;38;2;255;92;87:*.pkg=4;38;2;154;237;254:*.bag=4;38;2;154;237;254:*.txt=0;38;2;243;249;157:*.bbl=0;38;2;102;102;102:*.mpg=0;38;2;255;180;223:*.tar=4;38;2;154;237;254:*.wav=0;38;2;255;180;223:*.ppm=0;38;2;255;180;223:*.doc=0;38;2;255;92;87:*.bin=4;38;2;154;237;254:*.ilg=0;38;2;102;102;102:*.cgi=0;38;2;90;247;142:*.mid=0;38;2;255;180;223:*.ods=0;38;2;255;92;87:*.lua=0;38;2;90;247;142:*.pas=0;38;2;90;247;142:*.jar=4;38;2;154;237;254:*.zip=4;38;2;154;237;254:*.swp=0;38;2;102;102;102:*.tml=0;38;2;243;249;157:*.gif=0;38;2;255;180;223:*.dot=0;38;2;90;247;142:*.fnt=0;38;2;255;180;223:*.deb=4;38;2;154;237;254:*TODO=1:*.iso=4;38;2;154;237;254:*.log=0;38;2;102;102;102:*.pro=0;38;2;165;255;195:*.bst=0;38;2;243;249;157:*.svg=0;38;2;255;180;223:*.clj=0;38;2;90;247;142:*.yml=0;38;2;243;249;157:*.xml=0;38;2;243;249;157:*.jpg=0;38;2;255;180;223:*.tgz=4;38;2;154;237;254:*.htc=0;38;2;90;247;142:*.cxx=0;38;2;90;247;142:*.kts=0;38;2;90;247;142:*.sql=0;38;2;90;247;142:*.xcf=0;38;2;255;180;223:*.sxi=0;38;2;255;92;87:*.inl=0;38;2;90;247;142:*.bmp=0;38;2;255;180;223:*.pyo=0;38;2;102;102;102:*.bak=0;38;2;102;102;102:*.swf=0;38;2;255;180;223:*.mkv=0;38;2;255;180;223:*.vim=0;38;2;90;247;142:*.toc=0;38;2;102;102;102:*.rtf=0;38;2;255;92;87:*.ltx=0;38;2;90;247;142:*.fon=0;38;2;255;180;223:*.c++=0;38;2;90;247;142:*.out=0;38;2;102;102;102:*.aux=0;38;2;102;102;102:*.hpp=0;38;2;90;247;142:*.ps1=0;38;2;90;247;142:*.fsi=0;38;2;90;247;142:*.bz2=4;38;2;154;237;254:*.mir=0;38;2;90;247;142:*.blg=0;38;2;102;102;102:*.pod=0;38;2;90;247;142:*.exe=1;38;2;255;92;87:*.tcl=0;38;2;90;247;142:*.cpp=0;38;2;90;247;142:*.dox=0;38;2;165;255;195:*.ppt=0;38;2;255;92;87:*.nix=0;38;2;243;249;157:*.m4a=0;38;2;255;180;223:*.ogg=0;38;2;255;180;223:*.pid=0;38;2;102;102;102:*.sbt=0;38;2;90;247;142:*.erl=0;38;2;90;247;142:*.arj=4;38;2;154;237;254:*.wma=0;38;2;255;180;223:*.rst=0;38;2;243;249;157:*.kex=0;38;2;255;92;87:*.pps=0;38;2;255;92;87:*.gvy=0;38;2;90;247;142:*.elm=0;38;2;90;247;142:*.csv=0;38;2;243;249;157:*.bcf=0;38;2;102;102;102:*.ics=0;38;2;255;92;87:*.sxw=0;38;2;255;92;87:*.aif=0;38;2;255;180;223:*.pyc=0;38;2;102;102;102:*.cfg=0;38;2;243;249;157:*.m4v=0;38;2;255;180;223:*.mli=0;38;2;90;247;142:*.bib=0;38;2;243;249;157:*.ico=0;38;2;255;180;223:*.mov=0;38;2;255;180;223:*.fsx=0;38;2;90;247;142:*.otf=0;38;2;255;180;223:*.asa=0;38;2;90;247;142:*.tex=0;38;2;90;247;142:*.zsh=0;38;2;90;247;142:*.vob=0;38;2;255;180;223:*.tif=0;38;2;255;180;223:*.pdf=0;38;2;255;92;87:*.git=0;38;2;102;102;102:*.ini=0;38;2;243;249;157:*.avi=0;38;2;255;180;223:*.xmp=0;38;2;243;249;157:*.png=0;38;2;255;180;223:*.inc=0;38;2;90;247;142:*.dpr=0;38;2;90;247;142:*.tsx=0;38;2;90;247;142:*.flv=0;38;2;255;180;223:*.dmg=4;38;2;154;237;254:*.pyd=0;38;2;102;102;102:*.htm=0;38;2;243;249;157:*.ind=0;38;2;102;102;102:*.odt=0;38;2;255;92;87:*.zst=4;38;2;154;237;254:*.apk=4;38;2;154;237;254:*.xlr=0;38;2;255;92;87:*.csx=0;38;2;90;247;142:*.idx=0;38;2;102;102;102:*.sty=0;38;2;102;102;102:*.pbm=0;38;2;255;180;223:*.wmv=0;38;2;255;180;223:*.eps=0;38;2;255;180;223:*.rar=4;38;2;154;237;254:*.h++=0;38;2;90;247;142:*.hxx=0;38;2;90;247;142:*.mp3=0;38;2;255;180;223:*.ttf=0;38;2;255;180;223:*.bat=1;38;2;255;92;87:*.vcd=4;38;2;154;237;254:*.com=1;38;2;255;92;87:*.fls=0;38;2;102;102;102:*.def=0;38;2;90;247;142:*.ipp=0;38;2;90;247;142:*.tmp=0;38;2;102;102;102:*.xls=0;38;2;255;92;87:*hgrc=0;38;2;165;255;195:*.psd=0;38;2;255;180;223:*.pgm=0;38;2;255;180;223:*.odp=0;38;2;255;92;87:*.img=4;38;2;154;237;254:*.awk=0;38;2;90;247;142:*.orig=0;38;2;102;102;102:*.make=0;38;2;165;255;195:*.conf=0;38;2;243;249;157:*.fish=0;38;2;90;247;142:*.webm=0;38;2;255;180;223:*.opus=0;38;2;255;180;223:*.tiff=0;38;2;255;180;223:*.psm1=0;38;2;90;247;142:*.tbz2=4;38;2;154;237;254:*.purs=0;38;2;90;247;142:*.java=0;38;2;90;247;142:*.lock=0;38;2;102;102;102:*.docx=0;38;2;255;92;87:*.pptx=0;38;2;255;92;87:*.epub=0;38;2;255;92;87:*.html=0;38;2;243;249;157:*.rlib=0;38;2;102;102;102:*.mpeg=0;38;2;255;180;223:*.xlsx=0;38;2;255;92;87:*.less=0;38;2;90;247;142:*.yaml=0;38;2;243;249;157:*.psd1=0;38;2;90;247;142:*.json=0;38;2;243;249;157:*.h264=0;38;2;255;180;223:*.hgrc=0;38;2;165;255;195:*.jpeg=0;38;2;255;180;223:*.dart=0;38;2;90;247;142:*.diff=0;38;2;90;247;142:*.lisp=0;38;2;90;247;142:*.flac=0;38;2;255;180;223:*.toml=0;38;2;243;249;157:*.bash=0;38;2;90;247;142:*.toast=4;38;2;154;237;254:*.ipynb=0;38;2;90;247;142:*.scala=0;38;2;90;247;142:*shadow=0;38;2;243;249;157:*.mdown=0;38;2;243;249;157:*.dyn_o=0;38;2;102;102;102:*.cabal=0;38;2;90;247;142:*.swift=0;38;2;90;247;142:*.xhtml=0;38;2;243;249;157:*.cache=0;38;2;102;102;102:*.shtml=0;38;2;243;249;157:*README=0;38;2;40;42;54;48;2;243;249;157:*.class=0;38;2;102;102;102:*.patch=0;38;2;90;247;142:*.cmake=0;38;2;165;255;195:*passwd=0;38;2;243;249;157:*.gradle=0;38;2;90;247;142:*.flake8=0;38;2;165;255;195:*.matlab=0;38;2;90;247;142:*.groovy=0;38;2;90;247;142:*TODO.md=1:*.dyn_hi=0;38;2;102;102;102:*COPYING=0;38;2;153;153;153:*.ignore=0;38;2;165;255;195:*INSTALL=0;38;2;40;42;54;48;2;243;249;157:*LICENSE=0;38;2;153;153;153:*.config=0;38;2;243;249;157:*TODO.txt=1:*setup.py=0;38;2;165;255;195:*Doxyfile=0;38;2;165;255;195:*.desktop=0;38;2;243;249;157:*Makefile=0;38;2;165;255;195:*.gemspec=0;38;2;165;255;195:*.markdown=0;38;2;243;249;157:*.cmake.in=0;38;2;165;255;195:*COPYRIGHT=0;38;2;153;153;153:*.fdignore=0;38;2;165;255;195:*.kdevelop=0;38;2;165;255;195:*configure=0;38;2;165;255;195:*README.md=0;38;2;40;42;54;48;2;243;249;157:*.DS_Store=0;38;2;102;102;102:*.rgignore=0;38;2;165;255;195:*Dockerfile=0;38;2;243;249;157:*SConscript=0;38;2;165;255;195:*INSTALL.md=0;38;2;40;42;54;48;2;243;249;157:*.gitconfig=0;38;2;165;255;195:*SConstruct=0;38;2;165;255;195:*.gitignore=0;38;2;165;255;195:*README.txt=0;38;2;40;42;54;48;2;243;249;157:*CODEOWNERS=0;38;2;165;255;195:*.localized=0;38;2;102;102;102:*.scons_opt=0;38;2;102;102;102:*.gitmodules=0;38;2;165;255;195:*.synctex.gz=0;38;2;102;102;102:*Makefile.am=0;38;2;165;255;195:*Makefile.in=0;38;2;102;102;102:*LICENSE-MIT=0;38;2;153;153;153:*INSTALL.txt=0;38;2;40;42;54;48;2;243;249;157:*MANIFEST.in=0;38;2;165;255;195:*.travis.yml=0;38;2;90;247;142:*configure.ac=0;38;2;165;255;195:*CONTRIBUTORS=0;38;2;40;42;54;48;2;243;249;157:*.applescript=0;38;2;90;247;142:*appveyor.yml=0;38;2;90;247;142:*.fdb_latexmk=0;38;2;102;102;102:*.clang-format=0;38;2;165;255;195:*LICENSE-APACHE=0;38;2;153;153;153:*CMakeCache.txt=0;38;2;102;102;102:*CMakeLists.txt=0;38;2;165;255;195:*.gitattributes=0;38;2;165;255;195:*CONTRIBUTORS.md=0;38;2;40;42;54;48;2;243;249;157:*requirements.txt=0;38;2;165;255;195:*CONTRIBUTORS.txt=0;38;2;40;42;54;48;2;243;249;157:*.sconsign.dblite=0;38;2;102;102;102:*package-lock.json=0;38;2;102;102;102:*.CFUserTextEncoding=0;38;2;102;102;102'

# ZSH auto-completions
autoload -Uz compinit
# check cache only once a day
for dump in $HOME/.zcompdump(N.mh+24); do
    compinit
done
compinit -C
# colorize completions using default `ls` colors.
zstyle ':completion:*' list-colors ''
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"

# ZSH history
HISTFILE=$HOME/.zsh_history
setopt share_history

# Fancy ZSH improvements
for plugin_name in \
    $zsh_plugin_dir/zsh-autosuggestions/zsh-autosuggestions.zsh \
    $zsh_plugin_dir/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
do
    [ -f $plugin_name ] && source $plugin_name
done

# Enable fuzzy finder
if [ -n "$fzf_shell_dir" ]; then
    FZF_DEFAULT_OPTS="--layout=reverse --border=rounded --info=inline"
    #[[ ! "$PATH" == *$fzf_bin_dir* ]] && export PATH="${PATH:+${PATH}:}$fzf_bin_dir"
    #[[ $- == *i* ]] && source "$fzf_shell_dir/completion.zsh" 2> /dev/null
    source "$fzf_shell_dir/key-bindings.zsh"
fi

